<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="title">Attendance</title>
    <style>
        /* Your existing styles here */
    </style>
</head>
<body>
    <h1 id="branch-title">Branch: Loading...</h1>

    <input type="text" id="search" placeholder="Search by RegdNo" oninput="searchStudent()">
    
    <div>
        <button onclick="setAttendanceType('technical')">Technical</button>
        <button onclick="setAttendanceType('nonTechnical')">Non-Technical</button>
    </div>

    <div id="attributes"></div>

    <script>
        let students = [];
        let currentBranch = getBranchFromCookie(); // Get branch directly on load
        let currentAttendanceType = 'technical'; // Default to technical on load

        // Function to get the branch from cookie
        function getBranchFromCookie() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.split('=').map(c => c.trim());
                if (name === 'branch') {
                    return value; // Return the branch value from cookie
                }
            }
            return ''; // Return empty if none found
        }

        // Fetch attendance data from the server
        async function fetchAttendance() {
            const response = await fetch(`/attendanc?branch=${currentBranch}&attendanceType=${currentAttendanceType}`);
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const data = await response.json();
            return data;
        }

        // Set the attendance type (technical or non-technical)
        async function setAttendanceType(type) {
            currentAttendanceType = type;
            await loadAttendance(); // Reload attendance data based on the selected type
        }

        // Load attendance data
        async function loadAttendance() {
            try {
                students = await fetchAttendance();
                showAttributes();
            } catch (error) {
                console.error('Error fetching attendance:', error);
            }
        }

        // Show attributes in the table
        function showAttributes() {
            const attributesDiv = document.getElementById('attributes');
            attributesDiv.innerHTML = `
                <table>
                    <tr>
                        <th>RegdNo</th>
                        <th>Name</th>
                        <th>Attendance Percentage</th>
                    </tr>
                    ${students.map(student => `
                        <tr>
                            <td>${student.regdNo}</td>
                            <td>${student.name}</td>
                            <td>${currentAttendanceType === 'technical' ? student.technicalAttendance : student.nonTechnicalAttendance}</td>
                        </tr>
                    `).join('')}
                </table>
            `;
        }

        // Search for students by RegdNo
        function searchStudent() {
            const searchValue = document.getElementById('search').value;
            const filteredStudents = students.filter(student =>
                student.regdNo.includes(searchValue)
            );
            showAttributes(filteredStudents);
        }

        // Load branch data on page load
        window.onload = function() {
            if (currentBranch) {
                document.getElementById("branch-title").innerText = `Branch: ${currentBranch}`; // Display the branch
                loadAttendance(); // Load attendance data for the branch
            } else {
                document.getElementById("branch-title").innerText = 'Branch: Not Found';
            }
        };
    </script>
</body>
</html>
